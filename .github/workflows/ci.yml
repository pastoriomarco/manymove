name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ros_distro: [humble, jazzy]

    container:
      image: ros:${{ matrix.ros_distro }}-ros-base

    env:
      ROS_DISTRO: ${{ matrix.ros_distro }}
      COLCON_HOME: /tmp/colcon
      ROS_WS: /tmp/ros_ws
      CCACHE_DIR: /root/.ccache
      CCACHE_BASEDIR: /tmp/ros_ws
      CCACHE_COMPRESS: "1"
      CCACHE_MAXSIZE: 5G

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Cache compiler artifacts with ccache
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: /root/.ccache
          key: ccache-${{ matrix.ros_distro }}-${{ runner.os }}-v1
          restore-keys: |
            ccache-${{ matrix.ros_distro }}-

      - name: Install build tooling
        run: |
          set -e
          apt-get update
          apt-get install -y \
            ccache \
            ros-$ROS_DISTRO-topic-based-ros2-control \
            python3-colcon-common-extensions python3-rosdep git \
            ros-$ROS_DISTRO-moveit \
            ros-$ROS_DISTRO-ur \
            ros-$ROS_DISTRO-robotiq-description \
            ros-$ROS_DISTRO-robotiq-controllers \
            ros-$ROS_DISTRO-joint-state-publisher \
            ros-$ROS_DISTRO-control-toolbox \
            ros-$ROS_DISTRO-controller-manager \
            ros-$ROS_DISTRO-image-view \
            ros-$ROS_DISTRO-tf-transformations \
            ros-$ROS_DISTRO-find-object-2d \
            ros-$ROS_DISTRO-controller-manager-msgs \
            ros-$ROS_DISTRO-joint-state-broadcaster \
            ros-$ROS_DISTRO-joint-trajectory-controller \
            ros-$ROS_DISTRO-diff-drive-controller \
            ros-$ROS_DISTRO-joy \
            ros-$ROS_DISTRO-moveit-servo \
            ros-$ROS_DISTRO-behaviortree-cpp-v3 \
            ros-$ROS_DISTRO-moveit-visual-tools \
            ros-$ROS_DISTRO-vision-msgs \
            ros-$ROS_DISTRO-simulation-interfaces

      - name: Setup rosdep
        run: |
          rosdep update

      - name: Prepare workspace
        run: |
          mkdir -p ${ROS_WS}/src
          ln -s ${GITHUB_WORKSPACE} ${ROS_WS}/src/manymove

      - name: Install package dependencies
        shell: bash
        run: |
          set -e
          source /opt/ros/$ROS_DISTRO/setup.bash
          rosdep install --from-paths ${ROS_WS}/src --ignore-src --rosdistro ${ROS_DISTRO} -y

      - name: Build workspace
        shell: bash
        run: |
          set -e
          source /opt/ros/$ROS_DISTRO/setup.bash
          cd ${ROS_WS}
          # Show ccache status before build
          ccache -s || true
          colcon build \
            --base-paths ${ROS_WS}/src \
            --event-handlers console_cohesion+ \
            --cmake-args \
              -DCMAKE_C_COMPILER_LAUNCHER=ccache \
              -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          # Show ccache status after build
          ccache -s || true

      - name: Run tests
        shell: bash
        run: |
          set -e
          source /opt/ros/$ROS_DISTRO/setup.bash
          cd ${ROS_WS}
          colcon test \
            --base-paths src \
            --event-handlers console_cohesion+
          colcon test-result --verbose
